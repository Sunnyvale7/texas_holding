<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Hold'em - Premium Table</title>
    <style>
        :root {
            --table-green: radial-gradient(circle, #2d5a27 0%, #1a3a16 100%);
            --wood-brown: #3d2b1f;
            --bg-dark: #0f172a;
            --accent-blue: #38bdf8;
            --accent-gold: #fbbf24;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg-dark); 
            color: #e2e8f0;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            overflow: hidden;
        }

        /* è§†å›¾å®¹å™¨ */
        .view { display: none; width: 100%; height: 100vh; animation: fadeIn 0.5s; }
        .view.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 1. å¤§å…ä¸è®¾ç½®é¡µé¢ --- */
        .card-panel { 
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            width: 100%; 
            max-width: 500px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h2 { text-align: center; font-size: 28px; margin-bottom: 30px; letter-spacing: 1px; color: white; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #94a3b8; }
        input { 
            width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; 
            border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--accent-blue); outline: none; }

        button { 
            width: 100%; padding: 14px; background: #2563eb; color: white; border: none; 
            border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; 
            transition: all 0.3s; margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
        button.secondary { background: #475569; }
        button.danger { background: var(--accent-red); }
        button.action-btn { width: auto; min-width: 100px; padding: 10px 20px; }

        /* --- 2. ç‰Œæ¡Œæ ¸å¿ƒå¸ƒå±€ --- */
        .game-view-container { 
            position: relative; width: 100vw; height: 100vh; 
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
        }

        .poker-table-wrapper {
            position: relative; flex: 1; display: flex; justify-content: center; align-items: center;
            margin: 40px 0;
        }

        .poker-table {
            position: relative; width: 900px; height: 450px;
            background: var(--table-green);
            border: 15px solid var(--wood-brown);
            border-radius: 225px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5), 0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* ç‰Œæ¡Œä¸­å¤® */
        .table-center { text-align: center; z-index: 10; }
        #board { display: flex; gap: 10px; margin-bottom: 20px; min-height: 80px; }
        .pot-visual { 
            background: rgba(0,0,0,0.7); padding: 15px 40px; border-radius: 50px; 
            border: 3px solid var(--accent-gold); color: var(--accent-gold);
            font-size: 28px; font-weight: 800; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* ç©å®¶åº§ä½ */
        .seat {
            position: absolute; width: 160px; padding: 12px;
            background: rgba(15, 23, 42, 0.9); border-radius: 16px;
            border: 2px solid transparent; transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
        }
        .seat.active { border-color: var(--accent-blue); box-shadow: 0 0 20px rgba(56,189,248,0.4); z-index: 20; }
        .seat.folded { opacity: 0.6; filter: grayscale(0.8); }
        .seat.winner-highlight { border-color: var(--accent-gold); animation: winnerGlow 1.5s infinite alternate; }
        @keyframes winnerGlow { from { box-shadow: 0 0 10px var(--accent-gold); } to { box-shadow: 0 0 30px var(--accent-gold); } }

        .player-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .player-name { font-weight: bold; font-size: 14px; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .player-stack { font-family: 'Monaco', monospace; color: var(--accent-gold); font-size: 13px; }
        
        /* ç­¹ç æ ·å¼ */
        .chip-container { display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .chip-stack { position: relative; width: 14px; height: 24px; display: inline-block; margin-right: -8px; }
        .chip { 
            position: absolute; width: 14px; height: 14px; border-radius: 50%; 
            border: 1px dashed rgba(255,255,255,0.4); left: 0;
        }

        /* åº„ä½/ç›²æ³¨åœ†ç›˜ */
        .blind-marker {
            position: absolute; width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 8px; font-weight: bold; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6); z-index: 15;
            transform: translate(-50%, -50%); border: 2px solid rgba(0,0,0,0.2);
            text-align: center; line-height: 1.1; padding: 4px; box-sizing: border-box;
        }
        .marker-dealer { background: #ffffff; color: #333; }
        .marker-sb { background: #fbbf24; color: #000; }
        .marker-bb { background: #3b82f6; color: #fff; }

        .chip-gold { background: #fbbf24; }
        .chip-purple { background: #a855f7; }
        .chip-black { background: #1e293b; }
        .chip-green { background: #22c55e; }
        .chip-blue { background: #3b82f6; }
        .chip-red { background: #ef4444; }

        /* æ‰‘å…‹ç‰Œæ ·å¼ */
        .card { 
            width: 40px; height: 60px; background: white; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #1e293b; font-weight: 900; font-size: 18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); border: 1px solid #ddd;
            transition: transform 0.3s;
        }
        .card.suit-h, .card.suit-d { color: #ef4444; }
        .card.back { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: 2px solid white; }

        /* çŠ¶æ€æ¡ */
        .game-hud { position: fixed; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; }
        .hud-item { background: rgba(30,41,59,0.7); padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }

        /* æ§åˆ¶é¢æ¿ */
        .side-panel { 
            position: fixed; right: 20px; top: 20px; bottom: 20px; width: 300px;
            display: flex; flex-direction: column; gap: 20px;
        }
        .my-hand-card { background: rgba(30,41,59,0.8); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .log-container { flex: 1; background: #000; border-radius: 12px; padding: 10px; font-family: 'Monaco', monospace; font-size: 11px; color: #94a3b8; overflow-y: auto; opacity: 0.8; }

        .winner-banner { 
            position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
            background: var(--accent-gold); color: #000; padding: 15px 40px; 
            border-radius: 40px; font-size: 24px; font-weight: 800; z-index: 1000;
            box-shadow: 0 0 50px rgba(251,191,36,0.5); display: none;
        }

        /* æ¨¡æ€æ¡†ç»Ÿä¸€æ ·å¼ */
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 24px; width: 90%; max-width: 450px; text-align: center; }
    </style>
</head>
<body>

    <!-- 1. ç™»å½•å¤§å… -->
    <div id="lobbyView" class="view active">
        <div class="card-panel">
            <h2>å¾·å·æ‰‘å…‹ä¿±ä¹éƒ¨</h2>
            <div class="input-group"><label>æˆ¿é—´å·</label><input type="text" id="roomId" value="VIP-Room"></div>
            <div class="input-group"><label>ç©å®¶ ID</label><input type="text" id="playerId" value="Player1"></div>
            <div class="input-group"><label>æ˜µç§°</label><input type="text" id="playerName" value="ä¼ å¥‡èµŒç¥"></div>
            <button onclick="connect()">è¿›å…¥æ¸¸æˆ</button>
            <button class="secondary" onclick="toggleRules(true)">æŸ¥çœ‹ç‰Œå‹è§„åˆ™</button>
        </div>
    </div>

    <!-- 2. ç­‰å¾…/è®¾ç½®ç•Œé¢ -->
    <div id="setupView" class="view">
        <div class="card-panel" style="max-width: 600px;">
            <h2 id="setupTitle">æˆ¿é—´ç­‰å¾…ä¸­...</h2>
            <div id="playerList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px;"></div>
            <div class="input-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><label>å°ç›² (SB)</label><input type="number" id="sbInput" value="10"></div>
                <div><label>å¤§ç›² (BB)</label><input type="number" id="bbInput" value="20"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="secondary" onclick="updateConfig()">åŒæ­¥è§„åˆ™</button>
                <select id="aiLevel" style="flex: 1; background: #0f172a; color: white; border-radius: 12px; border: 1px solid #334155; padding: 0 10px;">
                    <option value="simple">åˆçº§æœºå™¨äºº</option>
                    <option value="medium">ä¸­çº§æœºå™¨äºº</option>
                    <option value="hard">é«˜çº§ AI</option>
                </select>
                <button onclick="addAI()" style="flex: 1;">æ·»åŠ  AI</button>
            </div>
            <div style="display: flex; gap: 15px;">
                <button onclick="sendReady()" style="flex: 2; background: var(--accent-green);">æˆ‘å‡†å¤‡å¥½äº†</button>
                <button onclick="leaveRoom()" class="danger" style="flex: 1;">ç¦»å¼€</button>
            </div>
        </div>
    </div>

    <!-- 3. æ¸¸æˆæ ¸å¿ƒç•Œé¢ -->
    <div id="gameView" class="view">
        <div id="winnerBanner" class="winner-banner"></div>
        
        <div class="game-hud">
            <div class="hud-item"><strong id="displayStreet">PREFLOP</strong></div>
            <div class="hud-item" style="color: var(--accent-red); font-weight: bold;" id="activePlayers">åœ¨åœº: 0äºº</div>
            <div class="hud-item" id="turnInfo">ç­‰å¾…è¡ŒåŠ¨...</div>
        </div>

        <div class="game-view-container">
            <div class="poker-table-wrapper">
                <div class="poker-table">
                    <div class="table-center">
                        <div id="board"></div>
                        <div class="pot-visual">
                            <div id="potChips"></div>
                            <span>åº•æ± : </span><span id="displayPot">0</span>
                        </div>
                    </div>
                    <!-- åŠ¨æ€ç”Ÿæˆçš„åº§ä½ -->
                    <div id="seatsContainer"></div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="side-panel">
                <div class="my-hand-card">
                    <h4 style="margin: 0 0 15px 0; color: #94a3b8; font-size: 14px;">æˆ‘çš„æ‰‹ç‰Œ</h4>
                    <div id="myHole" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;"></div>
                    <div id="actionControls" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    <div id="raiseBox" style="margin-top: 15px; display:none;">
                        <input type="number" id="raiseAmount" style="padding: 8px; margin-bottom: 5px;">
                        <div id="raiseHint" style="font-size: 11px; color: #64748b;"></div>
                    </div>
                </div>
                <div class="log-container" id="log"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="secondary action-btn" onclick="toggleRules(true)">è§„åˆ™</button>
                    <button class="danger action-btn" onclick="leaveRoom()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div id="loanModal" class="modal"><div class="modal-content"><h3>ç ´äº§è´·æ¬¾</h3><p id="loanMessage"></p><button onclick="respondLoan(true)">ç”³è¯· (ä¸Šé™3æ¬¡)</button><button class="danger" onclick="respondLoan(false)">ç¦»å¼€</button></div></div>
    <div id="seeRequestModal" class="modal"><div class="modal-content"><h3>çœ‹ç‰Œè¯·æ±‚</h3><p id="seeRequestMessage"></p><button onclick="respondSeeRequest(true)">åŒæ„ (æ”¶ä¸‹ç­¹ç )</button><button class="danger" onclick="respondSeeRequest(false)">æ‹’ç»</button></div></div>
    <div id="summaryModal" class="modal"><div class="modal-content"><h2>æœ¬åœºç»“ç®—</h2><div id="summaryTable"></div><button onclick="location.reload()">è¿”å›å¤§å…</button></div></div>
    <div id="rulesModal" class="modal" onclick="toggleRules(false)"><div class="modal-content" style="text-align: left;"><h3>ç‰Œå‹å¤§å°</h3><p>åŒèŠ±é¡º > å››æ¡ > è‘«èŠ¦ > åŒèŠ± > é¡ºå­ > ä¸‰æ¡ > ä¸¤å¯¹ > ä¸€å¯¹ > é«˜ç‰Œ</p><button onclick="toggleRules(false)">å…³é—­</button></div></div>

    <script>
        let ws;
        let myPlayerId = "";
        let isIntentionalLeave = false;

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function toggleRules(show) { document.getElementById('rulesModal').style.display = show ? 'flex' : 'none'; }

        function connect() {
            const rid = document.getElementById('roomId').value;
            const pid = document.getElementById('playerId').value;
            const name = document.getElementById('playerName').value;
            myPlayerId = pid;
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${protocol}://${window.location.host}/ws/${rid}/${pid}`);
            
            ws.onopen = () => { showView('setupView'); document.getElementById('setupTitle').innerText = `ä¿±ä¹éƒ¨: ${rid}`; };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === "handshake") ws.send(JSON.stringify({ type: "join", name: name, stack: 2000 }));
                else if (data.type === "state") updateUI(data);
                else if (data.type === "see_request") showSeeRequestModal(data.requester_name, data.amount);
                else if (data.type === "loan_request") showModal('loanModal', data.message);
                else if (data.type === "game_summary") showSummaryModal(data.summary);
                else if (data.type === "error") alert(data.message);
            };
            ws.onclose = () => { if (!isIntentionalLeave) { alert("è¿æ¥å·²æ–­å¼€"); location.reload(); } };
        }

        function renderChips(amount, isRed = false) {
            if (amount <= 0) return "";
            let color = isRed ? "chip-red" : "";
            if (!color) {
                if (amount >= 1000) color = "chip-gold";
                else if (amount >= 500) color = "chip-purple";
                else if (amount >= 100) color = "chip-black";
                else if (amount >= 25) color = "chip-green";
                else color = "chip-blue";
            }
            const total = Math.min(15, Math.ceil(amount / 20));
            const stacks = Math.ceil(total / 5);
            let html = `<div class="chip-container">`;
            for (let s = 0; s < stacks; s++) {
                html += `<div class="chip-stack">`;
                const count = Math.min(5, total - s * 5);
                for (let i = 0; i < count; i++) html += `<div class="chip ${color}" style="bottom: ${i * 3}px; z-index: ${i}"></div>`;
                html += `</div>`;
            }
            html += `<span style="margin-left:10px">${amount}</span></div>`;
            return html;
        }

        function formatCard(c) {
            if (c === "??" || !c) return `<div class="card back">?</div>`;
            const suit = c.slice(-1), val = c.slice(0, -1);
            const suitIcon = { 's': 'â™ ', 'h': 'â™¥', 'd': 'â™¦', 'c': 'â™£' }[suit];
            return `<div class="card suit-${suit}">${val}<span>${suitIcon}</span></div>`;
        }

        function updateUI(data) {
            const pub = data.public;
            if (pub.street !== "HAND_OVER") showView('gameView');

            // 1. è®¾ç½®é¡µç©å®¶åˆ—è¡¨
            const readySet = new Set(data.ready || []);
            document.getElementById('playerList').innerHTML = pub.seats.map(s => `
                <div class="hud-item" style="display:flex; align-items:center; gap:8px;">
                    ${s.name} ${readySet.has(s.player_id) ? 'âœ…' : 'â³'}
                    ${s.is_ai ? `<span style="cursor:pointer;color:red" onclick="kickAI('${s.player_id}')">Ã—</span>` : ''}
                </div>
            `).join('');

            // 2. ç‰Œæ¡Œæ›´æ–°
            document.getElementById('displayStreet').innerText = pub.street;
            document.getElementById('displayPot').innerText = pub.pot_total;
            document.getElementById('potChips').innerHTML = renderChips(pub.pot_total);
            document.getElementById('board').innerHTML = pub.board.map(formatCard).join('');
            document.getElementById('activePlayers').innerText = `åœ¨åœº: ${pub.seats.filter(s=>s.in_hand).length}äºº`;

            // è½®æ¬¡ä¿¡æ¯
            if (pub.street !== "HAND_OVER") {
                const currentPlayer = pub.seats[pub.to_act];
                let nextIdx = (pub.to_act + 1) % totalSeats;
                let nextPlayer = null;
                for (let j = 0; j < totalSeats; j++) {
                    const candidate = pub.seats[nextIdx];
                    if (candidate.in_hand && !candidate.all_in) {
                        nextPlayer = candidate;
                        break;
                    }
                    nextIdx = (nextIdx + 1) % totalSeats;
                }
                
                let turnText = `å½“å‰è¡ŒåŠ¨: <b style='color:var(--accent-blue)'>${currentPlayer.name}</b>`;
                if (nextPlayer && nextPlayer.player_id !== currentPlayer.player_id) {
                    turnText += ` | æ¥ä¸‹æ¥: <b style='color:#94a3b8'>${nextPlayer.name}</b>`;
                }
                document.getElementById('turnInfo').innerHTML = turnText;
            } else {
                document.getElementById('turnInfo').innerHTML = "æœ¬å±€å·²ç»“æŸ";
            }

            // 3. è½®æ¬¡ä¸èµ¢å®¶å¤„ç†
            let winnerSeats = new Set(), seatResults = {};
            if (pub.street === "HAND_OVER" && pub.history?.length) {
                const last = pub.history[pub.history.length-1];
                if (["SHOWDOWN", "WIN_NO_SHOWDOWN"].includes(last.action)) {
                    const winners = last.results?.filter(r=>r.won>0).map(r=>{winnerSeats.add(r.seat); return r.name;}) || [last.winner];
                    if (last.winner_seat !== undefined) winnerSeats.add(last.winner_seat);
                    document.getElementById('winnerBanner').innerText = `ğŸ† èµ¢å®¶: ${winners.join(', ')}`;
                    document.getElementById('winnerBanner').style.display = 'block';
                    last.results?.forEach(r => seatResults[r.seat] = r);
                }
            } else { document.getElementById('winnerBanner').style.display = 'none'; }

            // 4. åº§ä½åˆ†å¸ƒ (åŠ¨æ€è®¡ç®—æ¤­åœ†åæ ‡)
            const container = document.getElementById('seatsContainer');
            container.innerHTML = "";
            const myIdx = data.your_seat || 0;
            const totalSeats = pub.seats.length;

            pub.seats.forEach((s, i) => {
                // ä»¥ç©å®¶è‡ªå·±ä¸ºåº•éƒ¨ä¸­å¿ƒ (PI/2 å¼§åº¦)ï¼Œè®¡ç®—å‡åŒ€åˆ†å¸ƒçš„è§’åº¦
                const relativeIdx = (i - myIdx + totalSeats) % totalSeats;
                
                // è§’åº¦è®¡ç®—ï¼šPI/2 æ˜¯æ­£ä¸‹æ–¹ï¼Œé¡ºæ—¶é’ˆå¢åŠ è§’åº¦
                const angle = (Math.PI / 2) + (relativeIdx / totalSeats) * (Math.PI * 2);
                
                // æ¤­åœ†æ–¹ç¨‹åæ ‡ï¼šrx æ˜¯æ¨ªå‘åŠå¾„ï¼Œry æ˜¯çºµå‘åŠå¾„ (ç™¾åˆ†æ¯”)
                // å¢åŠ åŠå¾„ä½¿å¾—æ–¹æ¡†æ›´é è¾¹ç¼˜
                const rx = 48; 
                const ry = 45;
                const posX = 50 + rx * Math.cos(angle);
                const posY = 50 + ry * Math.sin(angle);

                const isToAct = pub.to_act === i && pub.street !== "HAND_OVER";
                const res = seatResults[i];
                
                const seatDiv = document.createElement('div');
                seatDiv.className = `seat ${isToAct?'active':''} ${!s.in_hand?'folded':''} ${winnerSeats.has(i)?'winner-highlight':''}`;
                seatDiv.style.left = `${posX}%`; 
                seatDiv.style.top = `${posY}%`;
                
                // ç»˜åˆ¶åº„ä½/ç›²æ³¨åœ†ç›˜ (ç¨å¾®é è¿‘ä¸­å¿ƒ)
                const markerRx = rx * 0.72;
                const markerRy = ry * 0.68;
                const markerX = 50 + markerRx * Math.cos(angle);
                const markerY = 50 + markerRy * Math.sin(angle);

                if (i === pub.button) {
                    const m = document.createElement('div');
                    m.className = 'blind-marker marker-dealer'; m.innerHTML = 'Dealer';
                    m.style.left = `${markerX}%`; m.style.top = `${markerY}%`;
                    container.appendChild(m);
                }
                if (i === pub.sb_pos) {
                    const m = document.createElement('div');
                    m.className = 'blind-marker marker-sb'; m.innerHTML = 'Small<br>Blind';
                    m.style.left = `${markerX}%`; m.style.top = `${markerY}%`;
                    container.appendChild(m);
                }
                if (i === pub.bb_pos) {
                    const m = document.createElement('div');
                    m.className = 'blind-marker marker-bb'; m.innerHTML = 'Big<br>Blind';
                    m.style.left = `${markerX}%`; m.style.top = `${markerY}%`;
                    container.appendChild(m);
                }

                let role = i === pub.button ? 'D' : (i === pub.sb_pos ? 'SB' : (i === pub.bb_pos ? 'BB' : ''));
                let cards = (i === data.your_seat ? data.your_hole : s.hole) || [];
                
                seatDiv.innerHTML = `
                    <div class="player-info">
                        <span class="player-name">${s.name} ${role?`[${role}]`:''}</span>
                        <span class="player-stack">ğŸ’°${s.stack}</span>
                    </div>
                    <div style="display:flex; gap:4px; justify-content:center; margin:5px 0;">${cards.map(formatCard).join('')}</div>
                    <div class="chip-container">æŠ•: ${renderChips(s.contributed_round, true)}</div>
                    ${res ? `<div style="color:${res.won-res.lost>0?'#4ade80':'#f87171'};font-size:11px;font-weight:bold;margin-top:4px">
                        æœ¬å±€: ${res.won-res.lost>0?'+':''}${res.won-res.lost}
                    </div>`:''}
                    ${pub.street === 'HAND_OVER' && i !== data.your_seat && s.in_hand && (!s.hole || s.hole[0]==="??") && !s.revealed ? 
                        `<button onclick="requestSee('${s.player_id}')" style="padding:2px;font-size:10px;margin-top:5px">ä¹°ç‰Œ</button>` : ''}
                `;
                container.appendChild(seatDiv);
            });

            // 5. è¡ŒåŠ¨æŒ‰é’®
            const controls = document.getElementById('actionControls');
            const raiseBox = document.getElementById('raiseBox');
            controls.innerHTML = ""; raiseBox.style.display = 'none';
            document.getElementById('myHole').innerHTML = data.your_hole.map(formatCard).join('');

            data.legal_actions.forEach(act => {
                const btn = document.createElement('button');
                btn.className = `action-btn ${act.type==='ALL_IN'?'danger':''}`;
                btn.innerText = act.type === 'CALL' ? `è·Ÿæ³¨(${act.to_amount})` : (act.type==='MUCK'?'è®¤è¾“':act.type);
                btn.onclick = () => {
                    if (['RAISE','BET'].includes(act.type)) takeAction(act.type, document.getElementById('raiseAmount').value || act.min_to);
                    else takeAction(act.type);
                };
                controls.appendChild(btn);
                if (['RAISE','BET'].includes(act.type)) {
                    raiseBox.style.display = 'block';
                    document.getElementById('raiseAmount').value = act.min_to;
                    document.getElementById('raiseHint').innerText = `${act.min_to} - ${act.max_to}`;
                }
            });

            if (pub.street === "HAND_OVER") {
                const nextBtn = document.createElement('button');
                nextBtn.innerText = "ä¸‹ä¸€å±€"; nextBtn.onclick = sendReady;
                controls.appendChild(nextBtn);
                const myS = pub.seats[data.your_seat];
                if (myS && !myS.revealed) {
                    const showBtn = document.createElement('button');
                    showBtn.innerText = "ç§€ç‰Œ"; showBtn.style.background = "#722ed1";
                    showBtn.onclick = () => ws.send(JSON.stringify({type:"show_cards"}));
                    controls.appendChild(showBtn);
                }
            }

            // æ—¥å¿—
            if (pub.history) {
                document.getElementById('log').innerHTML = pub.history.slice(-20).map(h => `<div>${h.name||'ç³»ç»Ÿ'}: ${h.action} ${h.to_amount||''} ${h.extra||''}</div>`).join('');
                document.getElementById('log').scrollTop = 9999;
            }
        }

        // è¾…åŠ©å‡½æ•°
        function showModal(id, msg) { document.getElementById(id).style.display = 'flex'; if(msg) document.getElementById(id).querySelector('p').innerText = msg; }
        function showSeeRequestModal(name, amt) { showModal('seeRequestModal', `ç©å®¶ ${name} æ”¯ä»˜ ${amt} ç­¹ç çœ‹ç‰Œï¼Ÿ`); }
        function respondSeeRequest(acc) { ws.send(JSON.stringify({ type: "respond_see_request", accept: acc })); document.getElementById('seeRequestModal').style.display='none'; }
        function requestSee(tid) { const amt = prompt("æ”¯ä»˜å¤šå°‘ç­¹ç ï¼Ÿ", "50"); if(amt) ws.send(JSON.stringify({ type: "request_see_cards", target_id: tid, amount: parseInt(amt) })); }
        function sendReady() { ws.send(JSON.stringify({ type: "ready" })); }
        function leaveRoom() { isIntentionalLeave = true; ws.send(JSON.stringify({ type: "leave" })); location.reload(); }
        function addAI() { ws.send(JSON.stringify({ type: "add_ai", level: document.getElementById('aiLevel').value, stack: 2000 })); }
        function kickAI(id) { ws.send(JSON.stringify({ type: "kick_ai", ai_id: id })); }
        function updateConfig() { ws.send(JSON.stringify({ type: "update_config", sb: parseInt(document.getElementById('sbInput').value), bb: parseInt(document.getElementById('bbInput').value) })); }
        function takeAction(t, amt) { ws.send(JSON.stringify({ type: "act", action: { type: t, to_amount: amt?parseInt(amt):null } })); }
        function respondLoan(acc) { if(!acc) isIntentionalLeave=true; ws.send(JSON.stringify({ type: "loan_response", accept: acc })); document.getElementById('loanModal').style.display='none'; }
        function showSummaryModal(s) {
            let html = `<table style="width:100%"><tr><th>ç©å®¶</th><th>ç›ˆäº</th></tr>`;
            s.sort((a,b)=>b.profit-a.profit).forEach(p=> {
                html += `<tr><td>${p.name}</td><td style="color:${p.profit>=0?'#4ade80':'#f87171'}">${p.profit}</td></tr>`;
            });
            document.getElementById('summaryTable').innerHTML = html + "</table>";
            showModal('summaryModal');
        }
    </script>
</body>
</html>
