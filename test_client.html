<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹ - å¤šæˆ¿é—´ç‰ˆ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card-panel { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h2 { text-align: center; color: #1a1a1a; margin-top: 0; }
        
        /* è§†å›¾åˆ‡æ¢ */
        .view { display: none; }
        .view.active { display: block; }

        /* å¤§å…æ ·å¼ */
        .lobby-form { display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { padding: 12px; background: #1890ff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #40a9ff; }
        button.secondary { background: #52c41a; }
        button.danger { background: #ff4d4f; }

        /* è®¾ç½®é¡µé¢æ ·å¼ */
        .player-tag { background: #f5f5f5; padding: 8px 12px; border-radius: 20px; display: inline-block; margin: 5px; border: 1px solid #eee; }
        .config-box { background: #fafafa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee; }

        /* æ¸¸æˆé¡µé¢æ ·å¼ */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; position: relative; z-index: 1050; }
        .container { display: flex; gap: 20px; }
        .table-area { flex: 2; }
        .side-panel { flex: 1; }
        .log { height: 200px; overflow-y: auto; background: #1e1e1e; color: #aaa; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 4px; margin-top: 10px; }
        .seat { border: 2px solid #eee; padding: 12px; margin-bottom: 10px; border-radius: 8px; position: relative; transition: all 0.3s; }
        .seat.active { border-color: #1890ff; background: #e6f7ff; transform: scale(1.02); }
        .card { display: inline-block; width: 35px; height: 50px; border: 1px solid #333; border-radius: 4px; text-align: center; line-height: 50px; margin-right: 4px; background: white; font-weight: bold; font-size: 14px; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .suit-h, .suit-d { color: #f5222d; }
        .controls { margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap; }

        /* è´·æ¬¾æ¨¡æ€æ¡† */
        #loanModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* è§„åˆ™æ¨¡æ€æ¡† */
        #rulesModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .rules-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow-y: auto;
        }
        .rules-list {
            text-align: left;
            line-height: 1.6;
            margin: 15px 0;
        }
        .rules-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            padding: 8px 0;
        }
        .rules-item:last-child { border-bottom: none; }
        .rules-rank { font-weight: bold; color: #1890ff; }
        .rules-desc { color: #666; font-size: 13px; }
    </style>
</head>
<body>

    <div id="loanModal">
        <div class="modal-content">
            <h3 style="margin-top:0">ç­¹ç å·²ç”¨å°½</h3>
            <p id="loanMessage"></p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button onclick="respondLoan(true)">ç”³è¯·è´·æ¬¾</button>
                <button class="danger" onclick="respondLoan(false)">ç¦»å¼€æˆ¿é—´</button>
            </div>
        </div>
    </div>

    <!-- ç¦»å¸­ç»“ç®—æ€»ç»“æ¨¡æ€æ¡† -->
    <div id="summaryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1100; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <h2 style="margin-top:0; color: #1890ff;">æ¸¸æˆç»“ç®—æ€»ç»“</h2>
            <div id="summaryTable" style="margin: 20px 0; max-height: 300px; overflow-y: auto;">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <p style="color: #666; font-size: 13px;">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œæˆ¿é—´å·²æ–­å¼€è¿æ¥ã€‚</p>
            <button onclick="location.reload()" style="width: 100%; margin-top: 10px;">è¿”å›å¤§å…</button>
        </div>
    </div>

    <!-- è§„åˆ™è¯´æ˜æ¨¡æ€æ¡† -->
    <div id="rulesModal">
        <div class="rules-content">
            <h3 style="margin-top:0; text-align:center; color: #1890ff;">å¾·å·æ‰‘å…‹ç‰Œå‹è§„åˆ™</h3>
            <div class="rules-list">
                <div class="rules-item"><span class="rules-rank">åŒèŠ±é¡º</span> <span class="rules-desc">äº”å¼ åŒèŠ±è‰²ä¸”è¿ç»­çš„ç‰Œ (æœ€é«˜ä¸ºçš‡å®¶åŒèŠ±é¡º)</span></div>
                <div class="rules-item"><span class="rules-rank">å››æ¡ (ç‚¸å¼¹)</span> <span class="rules-desc">å››å¼ ç›¸åŒæ•°å€¼çš„ç‰Œ + ä¸€å¼ å•ç‰Œ</span></div>
                <div class="rules-item"><span class="rules-rank">è‘«èŠ¦</span> <span class="rules-desc">ä¸‰å¼ ç›¸åŒæ•°å€¼ + ä¸€å¯¹</span></div>
                <div class="rules-item"><span class="rules-rank">åŒèŠ±</span> <span class="rules-desc">äº”å¼ åŒèŠ±è‰²çš„ç‰Œ (ä¸è¿ç»­)</span></div>
                <div class="rules-item"><span class="rules-rank">é¡ºå­</span> <span class="rules-desc">äº”å¼ è¿ç»­æ•°å€¼çš„ç‰Œ (ä¸åŒèŠ±è‰²)</span></div>
                <div class="rules-item"><span class="rules-rank">ä¸‰æ¡</span> <span class="rules-desc">ä¸‰å¼ ç›¸åŒæ•°å€¼ + ä¸¤å¼ å•ç‰Œ</span></div>
                <div class="rules-item"><span class="rules-rank">ä¸¤å¯¹</span> <span class="rules-desc">ä¸¤ä¸ªå¯¹å­ + ä¸€å¼ å•ç‰Œ</span></div>
                <div class="rules-item"><span class="rules-rank">ä¸€å¯¹</span> <span class="rules-desc">ä¸€ä¸ªå¯¹å­ + ä¸‰å¼ å•ç‰Œ</span></div>
                <div class="rules-item"><span class="rules-rank">é«˜ç‰Œ</span> <span class="rules-desc">ä¸æ»¡è¶³ä»¥ä¸Šä»»ä½•ç‰Œå‹ï¼ŒæŒ‰æœ€å¤§å•ç‰Œæ¯”å¤§å°</span></div>
            </div>
            <div style="background: #f6f6f6; padding: 10px; border-radius: 6px; font-size: 13px; color: #555; margin-bottom: 15px;">
                <strong>å¤§å°æ’åºï¼š</strong><br>
                åŒèŠ±é¡º > å››æ¡ > è‘«èŠ¦ > åŒèŠ± > é¡ºå­ > ä¸‰æ¡ > ä¸¤å¯¹ > ä¸€å¯¹ > é«˜ç‰Œ
            </div>
            <button onclick="toggleRules(false)" style="width: 100%;">å…³é—­</button>
        </div>
    </div>

    <div class="card-panel">
        <!-- 1. å¤§å…è§†å›¾ -->
        <div id="lobbyView" class="view active">
            <h2>æ¸¸æˆå¤§å…</h2>
            <div class="lobby-form">
                <div class="input-group">
                    <label>æˆ¿é—´å·</label>
                    <input type="text" id="roomId" value="room1">
                </div>
                <div class="input-group">
                    <label>ç©å®¶ID (å”¯ä¸€)</label>
                    <input type="text" id="playerId" value="player1">
                </div>
                <div class="input-group">
                    <label>æ˜µç§°</label>
                    <input type="text" id="playerName" value="å°ç‹">
                </div>
                <button onclick="connect()">è¿›å…¥æˆ¿é—´</button>
                <button class="secondary" style="background: #fa8c16;" onclick="toggleRules(true)">æŸ¥çœ‹è§„åˆ™</button>
            </div>
        </div>

        <!-- 2. è®¾ç½®/ç­‰å¾…è§†å›¾ -->
        <div id="setupView" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="setupTitle">æˆ¿é—´è®¾ç½®</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button style="padding: 4px 12px; font-size: 12px; background: #fa8c16; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="toggleRules(true)">æ¸¸æˆè§„åˆ™</button>
                    <span id="connStatus" style="font-size: 12px; color: green;">â— å·²è¿æ¥</span>
                </div>
            </div>
            
            <div class="config-box">
                <h4>å½“å‰ç©å®¶:</h4>
                <div id="playerList"></div>
            </div>

            <div class="config-box">
                <h4>è§„åˆ™è®¾ç½®:</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                    <label>å°ç›² (SB): <input type="number" id="sbInput" value="10" style="width: 60px;"></label>
                    <label>å¤§ç›² (BB): <input type="number" id="bbInput" value="20" style="width: 60px;"></label>
                    <label>åˆå§‹ç­¹ç : <input type="number" id="startStackInput" value="2000" style="width: 80px;"></label>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                    <button class="secondary" onclick="updateConfig()">åŒæ­¥è§„åˆ™</button>
                    <button class="secondary" onclick="resetStacks()">é‡ç½®ç­¹ç </button>
                    <div style="border: 1px solid #ccc; padding: 5px; border-radius: 6px; background: #fff;">
                        <select id="aiLevel" style="border: none; outline: none; padding: 5px;">
                            <option value="simple">åˆçº§æœºå™¨äºº (éšæœº)</option>
                            <option value="medium">ä¸­çº§æœºå™¨äºº (ç†æ™º)</option>
                            <option value="hard">é«˜çº§æœºå™¨äºº (RLè®­ç»ƒä¸­)</option>
                        </select>
                        <button class="secondary" style="background: #722ed1; padding: 5px 15px;" onclick="addAI()">æ·»åŠ æœºå™¨äºº</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button style="width: 200px; font-size: 18px;" onclick="sendReady()">æˆ‘å‡†å¤‡å¥½äº†ï¼</button>
            </div>
        </div>

        <!-- 3. æ¸¸æˆè§†å›¾ -->
        <div id="gameView" class="view">
            <div class="game-header">
                <div>
                    <strong id="displayStreet">PREFLOP</strong> | 
                    åº•æ± : <span id="displayPot" style="color: #52c41a; font-size: 1.2em;">0</span>
                    <span id="gameReadyList" style="margin-left:20px; font-size: 12px; color: #666;"></span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button style="padding: 4px 12px; font-size: 12px; background: #fa8c16;" onclick="toggleRules(true)">æ¸¸æˆè§„åˆ™</button>
                    <button class="danger" style="padding: 4px 12px; font-size: 12px;" onclick="leaveRoom()">é€€å‡ºæˆ¿é—´</button>
                </div>
            </div>

            <div class="container">
                <div class="table-area">
                    <div id="board" style="min-height: 60px; margin-bottom: 20px;"></div>
                    <div id="seatsList"></div>
                </div>

                <div class="side-panel">
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                        <h4>æˆ‘çš„æ‰‹ç‰Œ</h4>
                        <div id="myHole" style="margin-bottom: 15px;"></div>
                        <div id="actionControls" class="controls"></div>
                        <div id="raiseBox" style="margin-top: 10px; display:none;">
                            <input type="number" id="raiseAmount" style="width: 100px;">
                            <small id="raiseHint" style="display:block; color: #888;"></small>
                        </div>
                    </div>
                    <div class="log" id="log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let myPlayerId = "";

        let isIntentionalLeave = false;

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function toggleRules(show) {
            document.getElementById('rulesModal').style.display = show ? 'flex' : 'none';
        }

        function connect() {
            const rid = document.getElementById('roomId').value;
            const pid = document.getElementById('playerId').value;
            const name = document.getElementById('playerName').value;
            const stack = document.getElementById('startStackInput').value;
            myPlayerId = pid;

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.hostname || "127.0.0.1";
            // ä¿®å¤é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨å½“å‰é¡µé¢çš„ç«¯å£
            const port = window.location.port; 
            const wsUrl = `${protocol}://${host}${port ? ':' + port : ''}/ws/${rid}/${pid}`;
            
            console.log("Connecting to:", wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                const joinMsg = JSON.stringify({ type: "join", name: name, stack: parseInt(stack) });
                console.log("[DEBUG] WebSocket å·²è¿æ¥, å‘é€ join æ¶ˆæ¯:", joinMsg);
                ws.send(joinMsg);
                showView('setupView');
                document.getElementById('setupTitle').innerText = `æˆ¿é—´: ${rid}`;
            };

            ws.onmessage = (event) => {
                console.log("[DEBUG] æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:", event.data.substring(0, 100) + "...");
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "state") {
                        // åªæœ‰å½“å­˜åœ¨ public å­—æ®µæ—¶æ‰æ›´æ–° UI
                        if (data.public) {
                            updateUI(data);
                        } else {
                            console.log("[DEBUG] æ”¶åˆ°é UI çŠ¶æ€æ¶ˆæ¯:", data);
                        }
                    } else if (data.type === "loan_request") {
                        showLoanModal(data.message);
                    } else if (data.type === "game_summary") {
                        showSummaryModal(data.summary);
                    } else if (data.type === "error") {
                        console.error("[DEBUG] æœåŠ¡å™¨è¿”å›é”™è¯¯:", data.message);
                        alert(data.message);
                    }
                } catch (e) {
                    console.error("[DEBUG] è§£ææ¶ˆæ¯å¤±è´¥:", e);
                }
            };
                    showLoanModal(data.message);
                } else if (data.type === "game_summary") {
                    showSummaryModal(data.summary);
                } else if (data.type === "error") {
                    console.error("[DEBUG] æœåŠ¡å™¨è¿”å›é”™è¯¯:", data.message);
                    alert(data.message);
                }
            };

            ws.onerror = (err) => {
                console.error("[DEBUG] WebSocket å‘ç”Ÿé”™è¯¯:", err);
            };

            ws.onclose = (event) => {
                console.warn("[DEBUG] WebSocket å·²å…³é—­:", event.code, event.reason);
                if (!isIntentionalLeave) {
                    alert("è¿æ¥å·²æ–­å¼€ (" + event.code + ")");
                    showView('lobbyView');
                }
                hideLoanModal();
            };
        }

        function showLoanModal(msg) {
            document.getElementById('loanMessage').innerText = msg;
            document.getElementById('loanModal').style.display = 'flex';
        }

        function showSummaryModal(summary) {
            isIntentionalLeave = true; // æ ‡è®°ä¸ºæœ‰æ„ç¦»å¼€ï¼Œé˜²æ­¢ onclose å¼¹çª—
            const table = document.getElementById('summaryTable');
            let html = `
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #eee;">
                            <th style="text-align:left; padding: 8px;">ç©å®¶</th>
                            <th style="text-align:right; padding: 8px;">æœ€ç»ˆç›ˆäº</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            summary.sort((a, b) => b.profit - a.profit).forEach(s => {
                const color = s.profit >= 0 ? '#52c41a' : '#ff4d4f';
                const sign = s.profit > 0 ? '+' : '';
                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px 8px;">
                            ${s.name} ${s.is_ai ? '<small style="color:#999">(AI)</small>' : ''}
                        </td>
                        <td style="text-align:right; padding: 10px 8px; font-weight: bold; color: ${color};">
                            ${sign}${s.profit}
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            table.innerHTML = html;
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function hideLoanModal() {
            document.getElementById('loanModal').style.display = 'none';
        }

        function respondLoan(accept) {
            if (!accept) isIntentionalLeave = true;
            ws.send(JSON.stringify({ type: "loan_response", accept: accept }));
            hideLoanModal();
        }

        function leaveRoom() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                isIntentionalLeave = true;
                ws.send(JSON.stringify({ type: "leave" }));
            } else {
                location.reload();
            }
        }

        function sendReady() { ws.send(JSON.stringify({ type: "ready" })); }
        function updateConfig() {
            const sb = document.getElementById('sbInput').value;
            const bb = document.getElementById('bbInput').value;
            ws.send(JSON.stringify({ type: "update_config", sb: parseInt(sb), bb: parseInt(bb) }));
        }
        function resetStacks() {
            const stack = document.getElementById('startStackInput').value;
            ws.send(JSON.stringify({ type: "reset_stacks", stack: parseInt(stack) }));
        }
        function addAI() {
            const stack = document.getElementById('startStackInput').value;
            const level = document.getElementById('aiLevel').value;
            ws.send(JSON.stringify({ type: "add_ai", stack: parseInt(stack), level: level }));
        }
        function takeAction(type, amount = null) {
            const action = { type: type };
            if (amount !== null) action.to_amount = parseInt(amount);
            ws.send(JSON.stringify({ type: "act", action: action }));
        }

        function formatCard(c) {
            if (c === "??" || !c) return `<div class="card">?</div>`;
            const suit = c.slice(-1);
            const val = c.slice(0, -1);
            const suitClass = (suit === 'h' || suit === 'd') ? 'suit-h' : '';
            const suitIcon = { 's': 'â™ ', 'h': 'â™¥', 'd': 'â™¦', 'c': 'â™£' }[suit] || suit;
            return `<div class="card ${suitClass}">${val}${suitIcon}</div>`;
        }

        function updateUI(data) {
            const pub = data.public;
            
            // è§†å›¾è‡ªåŠ¨åˆ‡æ¢é€»è¾‘
            // åªæœ‰å½“ä»å¤§å…åˆšè¿›å…¥ï¼Œæˆ–è€…å½“å‰ä¸åœ¨æ¸¸æˆ/è®¾ç½®é¡µæ—¶ï¼Œæ‰æ ¹æ®çŠ¶æ€åˆ‡æ¢
            const isLobby = document.getElementById('lobbyView').classList.contains('active');
            const isGame = document.getElementById('gameView').classList.contains('active');
            const isSetup = document.getElementById('setupView').classList.contains('active');

            if (isLobby) {
                // å¦‚æœè¿˜åœ¨å¤§å…ï¼Œè¿æ¥æˆåŠŸåä¼šåˆ‡æ¢ï¼Œè¿™é‡Œä¸å¼ºåˆ¶
            } else if (pub.street !== "HAND_OVER") {
                if (!isGame) showView('gameView');
            } else {
                // HAND_OVER çŠ¶æ€ï¼šå¦‚æœå·²ç»åœ¨æ¸¸æˆé¡µï¼Œå°±ä¸è·³èµ°
                if (!isGame && !isSetup) showView('setupView');
            }

            // 1. è®¾ç½®é¡µé¢çš„ç©å®¶åˆ—è¡¨
            const readyPlayers = new Set(data.ready || []);
            const readyNames = pub.seats.filter(s => readyPlayers.has(s.player_id)).map(s => s.name);
            
            document.getElementById('playerList').innerHTML = pub.seats.map(s => `
                <span class="player-tag">
                    ${s.name} ${readyPlayers.has(s.player_id) ? 'âœ…' : 'â³'}
                </span>
            `).join('');

            // 2. æ¸¸æˆé¡µé¢æ›´æ–°
            document.getElementById('displayStreet').innerText = pub.street;
            document.getElementById('displayPot').innerText = pub.pot_total;
            document.getElementById('gameReadyList').innerText = readyNames.length > 0 ? ("å·²å‡†å¤‡: " + readyNames.join(', ')) : "";
            document.getElementById('board').innerHTML = pub.board.map(formatCard).join('');

            const seatsDiv = document.getElementById('seatsList');
            seatsDiv.innerHTML = pub.seats.map((s, idx) => {
                let role = '';
                if (idx === pub.button) role += ' [D]';
                if (idx === pub.sb_pos) role += ' [SB]';
                if (idx === pub.bb_pos) role += ' [BB]';

                // åº•ç‰Œæ˜¾ç¤ºé€»è¾‘ï¼š
                // 1. å¦‚æœæ˜¯æ‘Šç‰Œé˜¶æ®µ(s.holeé‡Œæœ‰æ˜ç‰Œæ•°æ®)ï¼Œæ˜¾ç¤ºæ˜ç‰Œ
                // 2. å¦‚æœæ˜¯è‡ªå·±çš„åº§ä½ï¼Œæ˜¾ç¤ºè‡ªå·±çš„åº•ç‰Œ(data.your_hole)
                // 3. å¦åˆ™æ˜¾ç¤ºèƒŒé¢(??)
                let displayCards = s.hole;
                if (idx === data.your_seat && data.your_hole && data.your_hole.length > 0 && (!s.hole || s.hole[0] === "??")) {
                    displayCards = data.your_hole;
                }

                let holeHtml = '';
                if (displayCards && displayCards.length > 0) {
                    holeHtml = `<div style="margin-top:8px;">${displayCards.map(formatCard).join('')}`;
                    if (s.hand_type) {
                        holeHtml += `<span style="margin-left:8px; color:#1890ff; font-weight:bold; font-size:12px; background:#e6f7ff; padding:2px 6px; border-radius:4px; border:1px solid #91d5ff;">${s.hand_type}</span>`;
                    }
                    if (s.best_5 && s.best_5.length > 0) {
                        holeHtml += `<div style="margin-top:5px; font-size:11px; color:#888;">æœ€ä½³5å¼ : ${s.best_5.map(c => `<span style="margin-right:2px; display:inline-block; border:1px solid #ccc; padding:0 2px; border-radius:2px; background:#fff; min-width:20px; text-align:center;">${c}</span>`).join('')}</div>`;
                    }
                    holeHtml += `</div>`;
                }

                return `
                    <div class="seat ${pub.to_act === idx ? 'active' : ''}">
                        <div style="display:flex; justify-content:space-between">
                            <strong>${s.name} <span style="color:#1890ff">${role}</span></strong>
                            <div>
                                <span style="font-size:12px; color:${s.total_profit >= 0 ? '#52c41a' : '#ff4d4f'}; margin-right:5px;">
                                    ${s.total_profit >= 0 ? '+' : ''}${s.total_profit}
                                </span>
                                ğŸ’°${s.stack}
                            </div>
                        </div>
                        <div style="font-size:12px; color:#666; margin-top:5px;">
                            æœ¬è½®æŠ•å…¥: ${s.contributed_round} | ${s.in_hand ? (s.all_in ? 'ALL-IN' : 'è¿›è¡Œä¸­') : 'å·²å¼ƒç‰Œ'}
                        </div>
                        ${holeHtml}
                    </div>
                `;
            }).join('');

            // æˆ‘çš„æ‰‹ç‰Œå’Œæ“ä½œ
            document.getElementById('myHole').innerHTML = data.your_hole.map(formatCard).join('');
            
            const controls = document.getElementById('actionControls');
            const raiseBox = document.getElementById('raiseBox');
            controls.innerHTML = '';
            raiseBox.style.display = 'none';

            data.legal_actions.forEach(act => {
                const btn = document.createElement('button');
                btn.innerText = act.type;
                if (act.type === 'ALL_IN') {
                    btn.className = 'danger';
                    btn.style.fontWeight = 'bold';
                    btn.onclick = () => takeAction('ALL_IN');
                } else {
                    btn.onclick = () => {
                        if (act.type === 'RAISE' || act.type === 'BET') {
                            const amt = document.getElementById('raiseAmount').value;
                            takeAction(act.type, amt || act.min_to);
                        } else {
                            takeAction(act.type);
                        }
                    };
                }
                controls.appendChild(btn);

                if (act.type === 'RAISE' || act.type === 'BET') {
                    raiseBox.style.display = 'block';
                    document.getElementById('raiseAmount').value = act.min_to;
                    document.getElementById('raiseHint').innerText = `èŒƒå›´: ${act.min_to} - ${act.max_to}`;
                }
            });

            // å¦‚æœæ˜¯å±€åç»“ç®—é˜¶æ®µï¼Œæ·»åŠ å¿«é€Ÿå¼€å§‹æŒ‰é’®
            if (pub.street === "HAND_OVER" && isGame) {
                // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶ç­¹ç ä¸º0
                const brokePlayer = pub.seats.find(s => s.stack <= 0);
                
                if (brokePlayer) {
                    const warnDiv = document.createElement('div');
                    warnDiv.style.color = '#faad14';
                    warnDiv.style.padding = '10px';
                    warnDiv.style.background = '#fffbe6';
                    warnDiv.style.border = '1px solid #ffe58f';
                    warnDiv.style.borderRadius = '4px';
                    warnDiv.style.marginBottom = '10px';
                    warnDiv.style.width = '100%';
                    warnDiv.innerHTML = `âš ï¸ ç©å®¶ <b>${brokePlayer.name}</b> ç­¹ç å·²ç”¨å°½ï¼Œç³»ç»Ÿæ­£åœ¨è¯¢é—®å…¶æ˜¯å¦è´·æ¬¾ç»§ç»­æ¸¸æˆã€‚`;
                    controls.appendChild(warnDiv);
                }

                const nextBtn = document.createElement('button');
                nextBtn.innerText = "ä¸‹ä¸€å±€ (å¿«é€Ÿå¼€å§‹)";
                nextBtn.className = "secondary";
                nextBtn.style.fontWeight = "bold";
                nextBtn.onclick = sendReady;
                controls.appendChild(nextBtn);

                const setupBtn = document.createElement('button');
                setupBtn.innerText = "è¿”å›è®¾ç½®é¡µ";
                setupBtn.onclick = () => showView('setupView');
                controls.appendChild(setupBtn);
            }

            // æ—¥å¿—
            if (pub.history) {
                const logHtml = pub.history.slice(-15).map(h => {
                    if (h.action === "SHOWDOWN") {
                        let res = `<div style="color: #ff9c6e; border-bottom: 1px solid #555; padding: 5px 0;">ã€æ¯”ç‰Œç»“ç®—ã€‘</div>`;
                        h.results.forEach(r => {
                            const profit = r.won - r.lost;
                            const color = profit > 0 ? "#52c41a" : (profit < 0 ? "#ff4d4f" : "#aaa");
                            const sign = profit > 0 ? "+" : "";
                            res += `<div style="font-size: 11px; margin-left: 5px;">
                                ${r.name}: <span style="color:${color}">${r.hand_type} (${sign}${profit})</span>
                                <small style="color:#777">[${r.hole.join('')}]</small>
                            </div>`;
                        });
                        return res;
                    }
                    if (h.action === "WIN_NO_SHOWDOWN") {
                        let res = `<div style="color: #ff9c6e; border-bottom: 1px solid #555; padding: 5px 0;">ã€æ”¶æ± ç»“ç®—ã€‘</div>`;
                        h.results.forEach(r => {
                            const profit = r.won - r.lost;
                            if (profit !== 0) {
                                const color = profit > 0 ? "#52c41a" : "#ff4d4f";
                                const sign = profit > 0 ? "+" : "";
                                res += `<div style="font-size: 11px; margin-left: 5px;">
                                    ${r.name}: <span style="color:${color}">${sign}${profit}</span>
                                </div>`;
                            }
                        });
                        return res;
                    }
                    
                    let m = h.name ? `<b>${h.name}</b> ` : "";
                    m += h.action;
                    if (h.to_amount) m += ` -> ${h.to_amount}`;
                    if (h.amount) m += ` ğŸ†${h.amount}`;
                    return `<div style="margin-bottom:4px; border-bottom:1px solid #333; padding-bottom:2px;">${m}</div>`;
                }).join('');
                document.getElementById('log').innerHTML = logHtml;
                const logObj = document.getElementById('log');
                logObj.scrollTop = logObj.scrollHeight;
            }
        }
    </script>
</body>
</html>
